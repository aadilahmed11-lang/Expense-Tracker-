# expense_kivy.py
import csv
import os
from datetime import datetime

from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.screenmanager import ScreenManager, Screen
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.uix.recycleview import RecycleView
from kivy.uix.popup import Popup
from kivy.metrics import dp

CSV_FILE = "expenses.csv"


# ---------- CSV helpers ----------
def ensure_csv():
    if not os.path.exists(CSV_FILE):
        with open(CSV_FILE, "w", newline="") as f:
            writer = csv.writer(f)
            writer.writerow(["date", "category", "amount", "note"])


def add_row(date, category, amount, note=""):
    with open(CSV_FILE, "a", newline="") as f:
        writer = csv.writer(f)
        writer.writerow([date, category, amount, note])


def read_rows():
    ensure_csv()
    with open(CSV_FILE, "r", newline="") as f:
        reader = csv.DictReader(f)
        return list(reader)


def delete_row(index):
    rows = read_rows()
    if 0 <= index < len(rows):
        rows.pop(index)
        with open(CSV_FILE, "w", newline="") as f:
            writer = csv.writer(f)
            writer.writerow(["date", "category", "amount", "note"])
            for r in rows:
                writer.writerow([r["date"], r["category"], r["amount"], r["note"]])


# ---------- Screens ----------
class AddScreen(Screen):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        layout = BoxLayout(orientation="vertical", padding=dp(10), spacing=dp(8))

        self.date_in = TextInput(text=datetime.today().strftime("%Y-%m-%d"), multiline=False)
        self.cat_in = TextInput(text="Food", multiline=False)
        self.amt_in = TextInput(hint_text="Amount", multiline=False, input_filter="float")
        self.note_in = TextInput(hint_text="Note", multiline=False)

        layout.add_widget(Label(text="Date (YYYY-MM-DD)"))
        layout.add_widget(self.date_in)
        layout.add_widget(Label(text="Category"))
        layout.add_widget(self.cat_in)
        layout.add_widget(Label(text="Amount"))
        layout.add_widget(self.amt_in)
        layout.add_widget(Label(text="Note (optional)"))
        layout.add_widget(self.note_in)

        btn = Button(text="Save", size_hint_y=None, height=dp(40))
        btn.bind(on_release=self.on_save)
        layout.add_widget(btn)

        self.add_widget(layout)

    def on_save(self, instance):
        try:
            date_text = self.date_in.text.strip()
            # validate date
            datetime.strptime(date_text, "%Y-%m-%d")

            category = self.cat_in.text.strip() or "Other"
            amount = float(self.amt_in.text.strip())
            note = self.note_in.text.strip()

            add_row(date_text, category, amount, note)

            popup = Popup(title="Saved", content=Label(text="Expense added."),
                          size_hint=(0.7, 0.3))
            popup.open()

            # clear fields
            self.amt_in.text = ""
            self.note_in.text = ""
        except ValueError:
            popup = Popup(title="Error", content=Label(text="Invalid data. Check date/amount."),
                          size_hint=(0.7, 0.3))
            popup.open()


class ViewRV(RecycleView):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.refresh()

    def refresh(self):
        rows = read_rows()
        data = []
        for i, r in enumerate(rows):
            note = r.get('note', '')
            text = f"{i}. {r['date']} | {r['category']} | ₹{r['amount']} | {note}"

            data.append({"text": text, "size_hint_y": None, "height": dp(32)})
        self.data = data


class ViewScreen(Screen):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        layout = BoxLayout(orientation="vertical", padding=dp(6))
        self.rv = ViewRV()
        layout.add_widget(self.rv)

        btns = BoxLayout(size_hint_y=None, height=dp(48))
        refresh_btn = Button(text="Refresh")
        refresh_btn.bind(on_release=lambda x: self.rv.refresh())
        delete_btn = Button(text="Delete by index")
        delete_btn.bind(on_release=self.delete_by_index_popup)
        btns.add_widget(refresh_btn)
        btns.add_widget(delete_btn)
        layout.add_widget(btns)
        self.add_widget(layout)

    def delete_by_index_popup(self, instance):
        content = BoxLayout(orientation="vertical", spacing=dp(6), padding=dp(6))
        idx_input = TextInput(hint_text="Enter index number", input_filter="int", multiline=False)
        content.add_widget(idx_input)
        btn_box = BoxLayout(size_hint_y=None, height=dp(40))
        ok = Button(text="Delete"); cancel = Button(text="Cancel")
        btn_box.add_widget(ok); btn_box.add_widget(cancel)
        content.add_widget(btn_box)

        popup = Popup(title="Delete Expense", content=content, size_hint=(0.8, 0.4))
        ok.bind(on_release=lambda x: self.do_delete(idx_input.text, popup))
        cancel.bind(on_release=popup.dismiss)
        popup.open()

    def do_delete(self, idx_text, popup):
        try:
            idx = int(idx_text)
            delete_row(idx)
            popup.dismiss()
            self.rv.refresh()
            Popup(title="Deleted", content=Label(text="Row deleted."), size_hint=(0.7, 0.3)).open()
        except Exception:
            Popup(title="Error", content=Label(text="Invalid index."), size_hint=(0.7, 0.3)).open()


class SummaryScreen(Screen):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.layout = BoxLayout(orientation="vertical", padding=dp(8), spacing=dp(6))
        self.add_widget(self.layout)
        self.refresh()

    def refresh(self):
        self.layout.clear_widgets()
        rows = read_rows()
        summary = {}
        for r in rows:
            summary[r["category"]] = summary.get(r["category"], 0) + float(r["amount"])

        if not summary:
            self.layout.add_widget(Label(text="No expenses yet."))
            return

        for cat, amt in summary.items():
            self.layout.add_widget(Label(text=f"{cat}: ₹{amt:.2f}"))


# ---------- App and Manager ----------
class ExpenseApp(App):
    def build(self):
        ensure_csv()
        sm = ScreenManager()
        sm.add_widget(AddScreen(name="add"))
        sm.add_widget(ViewScreen(name="view"))
        sm.add_widget(SummaryScreen(name="summary"))

        root = BoxLayout(orientation="vertical")
        # top nav
        nav = BoxLayout(size_hint_y=None, height=dp(48))
        b1 = Button(text="Add"); b2 = Button(text="View"); b3 = Button(text="Summary")
        b1.bind(on_release=lambda x: setattr(sm, "current", "add"))
        b2.bind(on_release=lambda x: setattr(sm, "current", "view"))
        b3.bind(on_release=lambda x: setattr(sm, "current", "summary"))

        nav.add_widget(b1); nav.add_widget(b2); nav.add_widget(b3)
        root.add_widget(nav)
        root.add_widget(sm)
        return root


if __name__ == "__main__":
    ExpenseApp().run()
